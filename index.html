<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スプラ3 ステージ情報</title>
<style>
  body { font-family: sans-serif; padding: 10px; }
  h2 { margin-top: 20px; }
  .stage { display: flex; align-items: center; margin-bottom: 10px; }
  .stage img { width: 100px; height: auto; margin-right: 10px; }
</style>
</head>
<body>
<h1>スプラトゥーン3 現在のステージ</h1>

<div id="regular"></div>
<div id="bankara-challenge"></div>
<div id="bankara-open"></div>

<script>
// ==================== PWA & 通知設定 ==================== //
if ('Notification' in window && 'serviceWorker' in navigator) {
  Notification.requestPermission().then(permission => {
    if (permission === 'granted') {
      navigator.serviceWorker.register('sw.js').then(() => {
        console.log('Service Worker registered');
      });
    }
  });
}

// ==================== ステージ情報取得 ==================== //
async function fetchStageInfo() {
  const regularRes = await fetch("https://spla3.yuu26.com/regular/now");
  const challengeRes = await fetch("https://spla3.yuu26.com/bankara-challenge/now");
  const openRes = await fetch("https://spla3.yuu26.com/bankara-open/now");

  const regularData = await regularRes.json();
  const challengeData = await challengeRes.json();
  const openData = await openRes.json();

  displayMatch("regular", "レギュラーマッチ", regularData.results[0]);
  displayMatch("bankara-challenge", "バンカラマッチ（チャレンジ）", challengeData.results[0]);
  displayMatch("bankara-open", "バンカラマッチ（オープン）", openData.results[0]);

  checkForNotification(regularData.results[0], challengeData.results[0], openData.results[0]);
}

function displayMatch(elementId, title, data) {
  const container = document.getElementById(elementId);
  container.innerHTML = `<h2>${title} (${data.rule.name})</h2>` +
    data.stages.map(stage =>
      `<div class="stage">
        <img src="${stage.image}" alt="${stage.name}">
        <div>${stage.name}</div>
      </div>`
    ).join("");
}

// ==================== 通知チェック ==================== //
function checkForNotification(regular, challenge, open) {
  const key = "lastStages";
  const current = JSON.stringify({
    regular: regular.stages.map(s => s.name),
    challenge: challenge.stages.map(s => s.name),
    open: open.stages.map(s => s.name)
  });

  const previous = localStorage.getItem(key);
  if (previous && previous !== current) {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification("ステージ変更！", {
        body: "新しいステージが始まりました！",
        icon: "icon.png"
      });
    });
  }
  localStorage.setItem(key, current);
}

// ==================== 定期更新 ==================== //
fetchStageInfo();
setInterval(fetchStageInfo, 5 * 60 * 1000); // 5分ごと
</script>
</body>
</html>
